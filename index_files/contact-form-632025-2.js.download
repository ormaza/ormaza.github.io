function initContactForm() {
  const form = document.querySelector('form[action="/api/contact"]');
  if (!form) return;

  const submitButton = form.querySelector('button[type="submit"]');
  const inputs = form.querySelectorAll('input, textarea');
  
  if (!submitButton) return;

  // Define max lengths for each field
  const maxLengths = {
    firstName: 50,
    lastName: 50,
    email: 100,
    subject: 150,
    message: 1000
  };

  // Store original button text
  const originalButtonText = submitButton.textContent;

  function setLoadingState(isLoading) {
    if (isLoading) {
      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      inputs.forEach(input => {
        input.readOnly = true;
        input.classList.add('bg-gray-50', 'cursor-not-allowed');
      });
    } else {
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
      submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      inputs.forEach(input => {
        input.readOnly = false;
        input.classList.remove('bg-gray-50', 'cursor-not-allowed');
      });
    }
  }

  function showMessage(message, isSuccess = true) {
    const existingMessage = form.querySelector('[data-form-message]');
    if (existingMessage) {
      existingMessage.remove();
    }

    const messageEl = document.createElement('div');
    messageEl.setAttribute('data-form-message', '');
    messageEl.className = `p-4 rounded-lg mb-4 ${
      isSuccess 
        ? 'bg-green-50 text-green-800 border border-green-200' 
        : 'bg-red-50 text-red-800 border border-red-200'
    }`;
    messageEl.textContent = message;

    submitButton.parentNode.insertBefore(messageEl, submitButton);

    setTimeout(() => {
      if (messageEl.parentNode) {
        messageEl.remove();
      }
    }, 5000);
  }

  function showFieldError(input, message) {
    // Remove existing error message
    const existingError = input.parentNode.querySelector('[data-field-error]');
    if (existingError) {
      existingError.remove();
    }

    // Create error message element
    const errorEl = document.createElement('div');
    errorEl.setAttribute('data-field-error', '');
    errorEl.className = 'text-red-600 text-sm mt-1';
    errorEl.textContent = message;

    // Insert after input
    input.parentNode.appendChild(errorEl);
  }

  function clearFieldError(input) {
    const existingError = input.parentNode.querySelector('[data-field-error]');
    if (existingError) {
      existingError.remove();
    }
  }

  function resetForm() {
    form.reset();
    inputs.forEach(input => {
      input.classList.remove('border-red-500', 'border-green-500');
      clearFieldError(input);
    });
  }

  function validateInput(input) {
    const fieldName = input.name;
    const value = input.value.trim();
    const maxLength = maxLengths[fieldName];
    
    clearFieldError(input);

    // Check required fields
    if (input.hasAttribute('required') && !value) {
      input.classList.add('border-red-500');
      input.classList.remove('border-green-500');
      showFieldError(input, 'This field is required');
      return false;
    }

    // Check max length
    if (maxLength && value.length > maxLength) {
      input.classList.add('border-red-500');
      input.classList.remove('border-green-500');
      showFieldError(input, `Maximum ${maxLength} characters allowed`);
      return false;
    }

    // Email validation
    if (input.type === 'email' && value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        input.classList.add('border-red-500');
        input.classList.remove('border-green-500');
        showFieldError(input, 'Please enter a valid email address');
        return false;
      }
    }
    
    // Valid input styling
    if (value) {
      input.classList.add('border-green-500');
      input.classList.remove('border-red-500');
    } else {
      input.classList.remove('border-red-500', 'border-green-500');
    }
    
    return true;
  }

  function validateForm() {
    let isValid = true;
    inputs.forEach(input => {
      if (!validateInput(input)) {
        isValid = false;
      }
    });
    return isValid;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    
    // Clear previous messages
    const existingMessage = form.querySelector('[data-form-message]');
    if (existingMessage) {
      existingMessage.remove();
    }

    // Validate form before submission
    if (!validateForm()) {
      showMessage('Please fix the errors above before submitting.', false);
      return;
    }

    const formData = new FormData(form);
    setLoadingState(true);

    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      const result = await response.json();

      if (result.success) {
        showMessage('Message sent successfully! Thank you for contacting us.', true);
        resetForm();
      } else {
        showMessage(result.message || 'Failed to send message. Please try again.', false);
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showMessage('An error occurred. Please try again later.', false);
    } finally {
      setLoadingState(false);
    }
  }

  // Add event listeners
  inputs.forEach(input => {
    // Real-time validation
    input.addEventListener('blur', () => validateInput(input));
    input.addEventListener('input', () => {
      if (input.classList.contains('border-red-500')) {
        validateInput(input);
      }
    });
  });

  // Form submission
  form.addEventListener('submit', handleSubmit);

  // Prevent double submission
  form.addEventListener('submit', (e) => {
    if (submitButton.disabled) {
      e.preventDefault();
    }
  });
}

document.addEventListener('DOMContentLoaded', initContactForm);
